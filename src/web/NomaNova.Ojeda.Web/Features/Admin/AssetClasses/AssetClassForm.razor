@using System.Net
@using NomaNova.Ojeda.Models.Dtos.FieldSets

@inject NavigationManager NavManager
@inject IToastService ToastService

<EditForm EditContext="_editContext" OnValidSubmit="OnSubmitForm">

    <FluentValidationValidator />
    <ServerSideFluentValidation @ref="_serverValidation" />
    
    <!-- Name -->
    <div class="mb-3 w-50">
        <label for="assetClassName" class="form-label">Name*</label>
        <InputText @bind-Value="_assetClass.Name" class="form-control" id="assetClassName" disabled="@_isLoading"></InputText>
        <ValidationMessage For="@(() => _assetClass.Name)"></ValidationMessage>
    </div>
    
    <!-- Description -->
    <div class="mb-3 w-50">
        <label for="assetClassDescription" class="form-label">Description</label>
        <InputText @bind-Value="_assetClass.Description" class="form-control" id="assetClassDescription" disabled="@_isLoading"></InputText>
        <ValidationMessage For="@(() => _assetClass.Description)"></ValidationMessage>
    </div>

    <!-- Field Sets -->
    <div class="mb-3 w-50">
        <div class="d-flex justify-content-between">
            <label class="form-label">Field Sets*</label>
            <a class="btn-link @(_isLoading ? "disabled" : "")" role="button" @onclick="@OnAddFieldSet">Add Field Set</a>
        </div>
        <div>
            @if (_assetClass.FieldSets?.Count > 0)
            {
                <table class="table">
                    <thead>
                    <tr>
                        <th class="py-2"><!-- Move up --></th>
                        <th class="py-2"><!-- Move down --></th>
                        <th class="py-2">Name</th>
                        <th class="py-2">Description</th>
                        <th class="py-2"><!-- Remove --></th>
                    </tr>
                    </thead>
                    <tbody>
                    @foreach (var assetClassFieldSet in _assetClass.FieldSets.OrderBy(f => f.Order))
                    {
                        <tr>
                            <td class="pb-2 pr-0">
                                @if (assetClassFieldSet.Order != 1 && _assetClass.FieldSets.Count > 1)
                                {
                                    <a class="text-dark text-decoration-none" title="Move up" role="button" @onclick="@(() => OnMoveFieldSetUp(assetClassFieldSet))">
                                        <i class="fs-6 bi-arrow-up-circle"></i>
                                    </a>
                                }
                            </td>
                            <td class="pb-2 pr-0">
                                @if (assetClassFieldSet.Order != _assetClass.FieldSets.Count && _assetClass.FieldSets.Count > 1)
                                {
                                    <a class="text-dark text-decoration-none" title="Move down" role="button" @onclick="@(() => OnMoveFieldSetDown(assetClassFieldSet))">
                                        <i class="fs-6 bi-arrow-down-circle"></i>
                                    </a>
                                }
                            </td>
                            <td class="pb-2 pr-3">@assetClassFieldSet.FieldSet.Name.Truncate()</td>
                            <td class="pb-2 pr-3">
                                @if (string.IsNullOrEmpty(assetClassFieldSet.FieldSet.Description))
                                {
                                    <span class="text-muted fst-italic">No description</span>
                                }
                                else
                                {
                                    @assetClassFieldSet.FieldSet.Description.Truncate()    
                                }
                            </td>
                            <td class="pb-2 pr-3">
                                <a class="text-dark text-decoration-none" title="Remove" role="button" @onclick="@(() => OnRemoveField(assetClassFieldSet))">
                                    <i class="fs-6 bi-x-circle"></i>
                                </a>
                            </td>
                        </tr>
                    }
                    </tbody>
                </table>
            }
            else
            {
                <p class="text-muted fst-italic">Use the link on the right to start adding field sets.</p>
            }
            <ValidationMessage For="@(() => _assetClass.FieldSets)"></ValidationMessage>
        </div>
    </div>

    <!-- Footer -->
    <div class="my-5">
        <button class="btn btn-primary" type="submit" disabled="@_isLoading">
            @if (_isLoading)
            {
                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                <span class="visually-hidden">Loading...</span>   
            }
            Submit
        </button>
        <button class="btn btn-secondary" type="button" @onclick="OnReset" disabled="@_isLoading">Reset</button>
        <button class="btn" type="button" @onclick="OnCancel" disabled="@_isLoading">Cancel</button>
    </div>

</EditForm>

@code {
    
    private AssetClassDto _assetClass;
    private EditContext _editContext;
    
    private ServerSideFluentValidation _serverValidation;
    
    private bool _isLoading;
    
    [CascadingParameter] 
    public IModalService Modal { get; set; }

    [Parameter]
    public AssetClassDto AssetClass { get; set; }
    
    [Parameter] 
    public Func<AssetClassDto, Task<OjedaDataResult<AssetClassDto>>> OnSubmit { get; set; }

    protected override void OnParametersSet()
    {
        base.OnParametersSet();
        
        Init();

        if (AssetClass != null)
        {
            _assetClass.Id = AssetClass.Id;
            _assetClass.Name = AssetClass.Name;
            _assetClass.Description = AssetClass.Description;
            
            _assetClass.FieldSets.Clear();
            _assetClass.FieldSets.AddRange(AssetClass.FieldSets.Select(_ => new AssetClassFieldSetDto
            {
                Order = _.Order,
                FieldSet = new FieldSetSummaryDto
                {
                    Id = _.FieldSet.Id,
                    Name = _.FieldSet.Name,
                    Description = _.FieldSet.Description,
                }
            }));
        }
    }

    protected override void OnInitialized()
    {
        Init();
    }
    
    private async Task OnAddFieldSet()
    {
        if (_isLoading)
        {
            return;
        }
        
        var parameters = new ModalParameters();
        
        var excludedIds = _assetClass.FieldSets.Select(_ => _.FieldSet.Id).ToList();
        parameters.Add("ExcludedIds", excludedIds);
        
        var selectFieldModal = Modal.Show<SelectFieldSetModal>("Add Field Set", parameters, Constants.DefaultModalOptions);
        var result = await selectFieldModal.Result;

        if (!result.Cancelled)
        {
            _assetClass.FieldSets.Add(new AssetClassFieldSetDto
            {
                Order = _assetClass.FieldSets.Count == 0 ? 1 : _assetClass.FieldSets.Max(f => f.Order) + 1,
                FieldSet = (FieldSetSummaryDto) result.Data
            });
            
            StateHasChanged();
        }
    }
    
    private void OnReset()
    {
        if (_isLoading)
        {
            return;
        }

        Init();
    }
    
    private void OnCancel()
    {
        if (_isLoading)
        {
            return;
        }
        
        NavManager.NavigateTo("/admin/asset-classes");
    }
    
    private void OnMoveFieldSetUp(AssetClassFieldSetDto assetClassFieldSetDto)
    {
        if (_isLoading)
        {
            return;
        }
        
        var index = _assetClass.FieldSets.IndexOf(assetClassFieldSetDto);
        
        _assetClass.FieldSets.RemoveAt(index);
        _assetClass.FieldSets.Insert(index - 1, assetClassFieldSetDto);
        
        UpdateOrder();
    }
    
    private void OnMoveFieldSetDown(AssetClassFieldSetDto assetClassFieldSetDto)
    {
        if (_isLoading)
        {
            return;
        }
        
        var index = _assetClass.FieldSets.IndexOf(assetClassFieldSetDto);
        
        _assetClass.FieldSets.RemoveAt(index);
        _assetClass.FieldSets.Insert(index + 1, assetClassFieldSetDto);
        
        UpdateOrder();
    }
    
    private void OnRemoveField(AssetClassFieldSetDto assetClassFieldSetDto)
    {
        if (_isLoading)
        {
            return;
        }
        
        _assetClass.FieldSets.Remove(assetClassFieldSetDto);
        UpdateOrder();
    }
    
    private async Task OnSubmitForm()
    {
        if (_isLoading)
        {
            return;
        }
        
        _isLoading = true;
        _serverValidation.ClearErrors();
        Init(_assetClass);
        
        var result = await OnSubmit(_assetClass);
        
        if(result.StatusCode == HttpStatusCode.BadRequest && result.Error.ValidationErrors.Any())
        {
            _serverValidation.DisplayErrors(result.Error.ValidationErrors);
        }
        else if (!result.Success)
        {
            ToastService.ShowError($"Could not submit asset class. {result.Error?.Message} ({result.Error?.Code}).");
        }
        else
        {
            NavManager.NavigateTo("/admin/asset-classes");
        }
        
        _isLoading = false;
    }
    
    private void Init(AssetClassDto assetClass = null)
    {
        _assetClass = assetClass ?? new AssetClassDto();
        
        _editContext = new EditContext(_assetClass);
        _editContext.SetFieldCssClassProvider(new BootstrapCssClassProvider());
    }
    
    private void UpdateOrder()
    {
        var order = 1;
        foreach (var assetClassFieldSet in _assetClass.FieldSets)
        {
            assetClassFieldSet.Order = order;
            order++;
        }
    }
}